# CICの概要
このドキュメントでは、Clova Interface Connect(以下、CIC)について説明します。このドキュメントから、CICとは何で、どのような仕組みで動作するかを知ることができます。また、ここではCICに関するガイドとリファレンスも提供されます。

## CICとは？ {#WhatisCIC}
CICは、AIアシスタントサービスを提供するパソコン・モバイルアプリ、モバイルデバイスまたは家電製品などのクライアントに、Clovaと連携できるインターフェースを提供するプラットフォームです。CICが提供する[API](/CIC/References/CIC_API.md)を使って、ユーザーのリクエストをClovaに送信し、CICを介して、Clovaからの応答をクライアントに提供します。

![](/CIC/Resources/Images/CIC_Interaction_Structure.png)

## CICの仕組み {#CICInteractionStructure}
クライアントは、CIC APIを使ってユーザーのリクエストをCICに送信し、その応答結果をCICから受け取ります。CICにアクセスするには、[HTTP/2プロトコル](https://tools.ietf.org/html/rfc7540)を使用する必要があります。音声認識、音声出力、オーディオ再生、スケジュール管理、アラーム、タイマー設定などの機能が[CIC API](/CIC/References/CIC_API.md)で提供されています。

CIC APIを使って、クライアントとCICの間でさまざまな通信が発生します。その際、通信の方向によって、次のようなタイプのメッセージが送信されます。

* [イベント](/CIC/References/CIC_API.md#Event)：クライアントからCICに送信するメッセージです。ユーザーのリクエスト(音声入力)や、クライアントのステータス値が変更されたことを示す際に使用されます。

* [ディレクティブ](/CIC/References/CIC_API.md#Directive)：CICからクライアントに対して、具体的なアクションをコントロールするためのメッセージです。例えば、アプリに特定の情報を表示したり、合成された音声を出力するように指示する際に送信されます。ディレクティブは次の状況で使用されます。
    * ユーザーのリクエストに対するレスポンスメッセージとして、主にユーザーの音声が認識された後、クライアントに適切な動作を指示するために送信されます。
    * 特定の条件により、ユーザーからのリクエストなしに、CICからクライアントにディレクティブを送信する場合もあります。

次は、CICとクライアントの間で行われるメッセージのやり取りを表すシーケンス図です。

![](/CIC/Resources/Images/CIC_Interaction_Example_in_Sequence_Diagram.png)

## ダイアログモデル {#DialogModel}
CICが提供するダイアログモデルを理解するために、次の内容を説明します。

* [間接ダイアログの仕組み](#IndirectDialog)
* [ダイアログIDとクライアントの動作](#DialogIDandClientOP)

### 間接ダイアログの仕組み {#IndirectDialog}
ユーザーとClovaは、一連の対話を交わします。通常、ユーザーはClovaに必要な情報を確認したり、動作を実行するようにリクエストし、Clovaはユーザーに検索した情報や動作の実行結果をレスポンスとして返します。その対話のため、ユーザーとClovaの間に、中継者の役割を担うクライアントとCICがあります。

普通の場合、ユーザーとClovaの対話は、次のようなシンプルなものになります。

1. ユーザーが発話を開始します。
2. クライアントはユーザーの音声をキャプチャし、CICに送信します。
3. クライアントは、CICから受け取った結果を、ユーザーに音声で伝えるか、画面に表示します。

ですが、このようにユーザーとClovaの間にクライアントとCICが存在する間接ダイアログは、次のような問題があります。

* リクエストを送信したり、レスポンスを受信する際、直接の対話より時間がかかります。
* ユーザーが新しいトピックの対話(リクエスト)を開始すると、すぐに対応することが難しいです。

例えば、ユーザーがClovaに「今日の天気はどう？」と聞き、待っていたとします。Clovaが応答する前、または応答している途中で、ユーザーから「楽しい曲をプレイして」とリクエストされることがあります。その場合、「今日の天気はどう？」に対する応答は、もうユーザーにとって必要な内容ではないはずです。直接の対話なら、容易に応答を中止したりキャンセルできます。ですが、中継方式の対話では、中継者であるクライアント側で状況を判断し、それに応じた動作を実行する必要があります。

### ダイアログIDとクライアントの動作 {#DialogIDandClientOP}

間接ダイアログの問題を解決するために、**ダイアログID**という概念が使用されます。**ダイアログID**は、ユーザーのリクエストを識別するために、ユーザーが発話を開始する度に作成されるIDです。クライアントは、CICに送信した最終リクエストのダイアログIDを保存していて、CICにリクエストを送信する度に、最終ダイアログIDを更新する必要があります。

CICは、リクエストに対する応答としてクライアントに送信するディレクティブに、リクエストを受信する際に渡されたダイアログIDを含めます。クライアントはダイアログIDを使って、CICから受信した結果が現在のリクエストに対して適切な応答かどうかを確認できます。クライアントは、次のように動作する必要があります。

1. ユーザーが新しい会話を開始する度に、**新しいダイアログID**を作成します。
  * 音声での発話の場合、 [SpeechRecognizer.Recognize](/CIC/References/CICInterface/SpeechRecognizer.md)イベントで、ユーザーのリクエストをCICに送信します。テキストでの指示の場合、[TextRecognizer.Recognize](/CIC/References/CICInterface/TextRecognizer.md)イベントを使用します。
  * そのとき、クライアントは[イベントのヘッダー](/CIC/References/CIC_API.md#Event)に新しく作成したダイアログIDを含め、**最終ダイアログID**として保存する必要があります。
2. クライアントは、CICからディレクティブを受信すると、[ディレクティブのヘッダー](/CIC/References/CIC_API.md#Directive)に含まれているダイアログIDと、クライアントが保存していた最終ダイアログIDを比較する必要があります。
  * **ディレクティブにダイアログIDが含まれていない場合**、**直ちに**受信したディレクティブに応じて、ユーザーに結果を伝えます。
  * ディレクティブにダイアログIDが含まれていて、**2つのダイアログIDが一致する場合**、受信したメッセージを[メッセージキュー](/CIC/Guides/Interact_with_CIC.md#ManageMessageQ)に追加し、順番になると、その内容をユーザーに伝えます。
  * ディレクティブにダイアログIDが含まれていて、**2つのダイアログIDが異なる場合**、受信したディレクティブを廃棄します。
  * クライアントは、新しいダイアログIDを持つディレクティブを処理するために、以下を実行する必要があります。
    * 以前のダイアログIDを持つディレクティブの内容をユーザーに提供していた場合、直ちに中止する必要があります。[オーディオ再生の基本ルール](/Design/Design_Guideline_For_Client_Hardware.md#AudioInterruptionRule)または[ユーザー発話時のオーディオ再生ルール](/Design/Design_Guideline_For_Client_Hardware.md#AudioInterruptionRuleForUserUtterance)を参照して、
    * メッセージキューから以前のダイアログIDを持つディレクティブをすべて廃棄する必要があります。そのために、メッセージキューに格納されているディレクティブのダイアログIDを常に確認する必要があります。
